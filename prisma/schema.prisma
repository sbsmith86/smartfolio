// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String      @id @default(cuid())
  email                 String      @unique
  passwordHash          String?
  googleId              String?     @unique
  firstName             String
  lastName              String
  location              String?
  phone                 String?
  profilePictureUrl     String?
  bio                   String?
  publicProfileEnabled  Boolean     @default(true)
  chatInterfaceEnabled  Boolean     @default(true)
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  lastLogin             DateTime?

  documents             UserDocument[]
  links                 UserLink[]
  testimonials          Testimonial[]
  skills                UserSkill[]
  experiences           Experience[]
  education             Education[]
  knowledgeEmbeddings   KnowledgeEmbedding[]
  chatSessions          ChatSession[]

  @@map("users")
}

model UserDocument {
  id            String    @id @default(cuid())
  userId        String
  documentType  String    // 'resume', 'portfolio', 'other'
  fileName      String
  filePath      String
  fileSize      BigInt
  mimeType      String
  processed     Boolean   @default(false)
  extractedText String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_documents")
}

model UserLink {
  id           String    @id @default(cuid())
  userId       String
  linkType     String    // 'linkedin', 'github', 'portfolio', 'other'
  url          String
  title        String?
  description  String?
  verified     Boolean   @default(false)
  createdAt    DateTime  @default(now())

  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_links")
}

model Testimonial {
  id                 String    @id @default(cuid())
  userId             String
  recommenderName    String
  recommenderTitle   String?
  recommenderCompany String?
  recommenderEmail   String?
  relationship       String?   // 'colleague', 'supervisor', 'client'
  content            String
  verified           Boolean   @default(false)
  public             Boolean   @default(true)
  createdAt          DateTime  @default(now())

  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("testimonials")
}

model Experience {
  id           String    @id @default(cuid())
  userId       String
  company      String
  position     String
  startDate    String    // Store as string for flexibility (e.g., "Jan 2020")
  endDate      String?   // Store as string, null for current
  description  String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("experiences")
}

model Education {
  id            String    @id @default(cuid())
  userId        String
  institution   String
  degree        String
  fieldOfStudy  String?
  startDate     String?
  endDate       String?
  description   String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("education")
}

model Skill {
  id          String      @id @default(cuid())
  name        String      @unique
  category    String?     // 'technical', 'soft', 'language', etc.
  createdAt   DateTime    @default(now())

  userSkills  UserSkill[]

  @@map("skills")
}

model UserSkill {
  id         String   @id @default(cuid())
  userId     String
  skillId    String
  level      String?  // 'beginner', 'intermediate', 'advanced', 'expert'
  yearsUsed  Int?
  createdAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  skill      Skill    @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([userId, skillId])
  @@map("user_skills")
}

model KnowledgeEmbedding {
  id            String    @id @default(cuid())
  userId        String
  contentType   String    // 'experience', 'skill', 'testimonial', 'document'
  contentId     String?
  textContent   String
  embedding     Float[]   // Vector embedding
  metadata      Json?
  createdAt     DateTime  @default(now())

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("knowledge_embeddings")
}

model ChatSession {
  id               String        @id @default(cuid())
  profileUserId    String
  visitorId        String?
  visitorEmail     String?
  sessionStartedAt DateTime      @default(now())
  sessionEndedAt   DateTime?
  totalMessages    Int           @default(0)

  profileUser      User          @relation(fields: [profileUserId], references: [id], onDelete: Cascade)
  messages         ChatMessage[]

  @@map("chat_sessions")
}

model ChatMessage {
  id        String      @id @default(cuid())
  sessionId String
  role      String      // 'user' | 'assistant'
  content   String
  createdAt DateTime    @default(now())

  session   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
}
